<!DOCTYPE html>
<html ng-app>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="/public/jquery/jquery-1.8.2.js"></script>
<script type="text/javascript" src="/public/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/public/angularjs/angular.min.js"></script>
<link rel="stylesheet" type="text/css" href="/public/bootstrap/css/bootstrap.min.css"/>
<title>INDEX</title>
<script type="text/javascript">
// var options = null;
$(document).ready(function() {
	// $.get('/award/options',function(data) {
	// 	options = data;
	// });
});

function TextController($scope, $http) {
	// $.get('/award/options',function(data) {
	// 	// options = data;
	// 	$scope.options = data;
	// 	$scope.someText = 'You have started your journey.';
	// });

// ******* WEB SOCKET *******
	var ws = null;     
    if ('WebSocket' in window)    
        ws = new WebSocket("ws://localhost:9000");    
    else if ('MozWebSocket' in window)    
        ws = new MozWebSocket("ws://localhost:9000");    
    else    
        alert("not support");    
        
        
    ws.onmessage = function(evt) {    
        alert('ws receive:' + evt.data);
        startInterval(evt.data);
    };    
        
    ws.onclose = function(evt) {    
        alert("close");    
    };    
        
    ws.onopen = function(evt) {    
        alert("open");    
    };    
    
	var sendMessage = function(msg) {    
    	ws.send(msg);    
	}  
// ******* WEB SOCKET *******

	$http({
		url: '/award/options'
	}).success(function(data, status) {
		$scope.options = data;
	}).error(function(data, status) {
		alert('error:' + data);
	});

	var users = null;
	var phones = [];
	$http({
		url: '/award/users'
	}).success(function(data, status) {
		users = data;
		// 把所有号码读入到phones数组中
		var num = 0;
		for (var i = 0; i < users.length; i++) {
			var people = users[i]['people'];
			for (var j = 0; j < people.length; j++) {
				// 判断是否在黑名单中
				var blackFlag = false;
				// for (var bk in blacks) {
				// 	if (blacks[bk] == people[j]['phone']) {
				// 		blackFlag = true;
				// 		break;
				// 	}
				// }
				// 不在黑名单中添加进号码列表
				if (blackFlag == false) {
					phones[num] = people[j];
					num++;
				}
			}
		}
		$('#prepare').text('准备完毕,可以开始了!');
	}).error(function(data, status) {
		alert('error:' + data);
	});

	var timer = null;
	var startFun = function(containerId) {
		sendMessage(containerId);
		startInterval(containerId);
	}
	var startInterval = function(containerId) {
		timer = setInterval(function() {
			$('#'+containerId+' .num').each(function() {
				var index = Math.floor(Math.random()*phones.length);
				var selPhone = phones[index]['phone'];


				$(this).text(selPhone);
			});
		}, 30);
	}
	$scope.start = startFun;

	// var timer = null;
	// $scope.start = function(containerId) {
	// 	timer = setInterval(function() {
	// 		$('#'+containerId+' .num').each(function() {
	// 			var index = Math.floor(Math.random()*phones.length);
	// 			var selPhone = phones[index]['phone'];


	// 			$(this).text(selPhone);
	// 		});
	// 	}, 30);
	// };
	
}

</script>
</head>
<body ng-controller="TextController">
	<span id="prepare"></span>
	<div ng-repeat="option in options">
		<div ng-repeat="group in option.groups" class="container" id="container{{option.id}}_{{group}}">
			<div class="row">
				<div class="col-sm-12"><h1 style="text-align: center">{{option.name}} {{group}}/{{option.total/option.count}}</h1></div>
			</div>
			<div class="row">
				<div ng-repeat="count in option.counts" class="col-sm-6" ng-class="{true: 'col-sm-offset-3', false: ''}[count==option.count&&count%2>0]">
					<div class="alert alert-danger">
						<h1 class="num">{{count}}</h1>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-6 col-sm-offset-3">
					<input id="group3start" type="button" class="btn btn-primary btn-block btn-lg" ng-click="start('container'+option.id+'_'+group)" value="启动"/>
				</div>
			</div>
		</div>
	</div>
</body>
</html>